<!doctype html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å€‹æ¡ˆæœå‹™ç´€éŒ„ â€” ç¤¾å·¥ç®¡ç†ç³»çµ±</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="shared.css" />
    <style>
      .page-container {
        max-width: 800px;
        margin: 0 auto;
        padding: 24px 16px;
        min-height: 100vh;
      }
      .page-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 20px;
      }
      .page-title {
        font-size: 20px;
        font-weight: 700;
        color: #1f2937;
        flex: 1;
      }
      .student-card-content {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      .student-card-name {
        font-size: 16px;
        font-weight: 600;
        color: #1f2937;
      }
      .student-card-class {
        font-size: 13px;
        color: #6b7280;
      }
      .student-card-footer {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-top: 4px;
        flex-wrap: wrap;
        gap: 6px;
      }
      .tags-group {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
      }
      .last-record-date {
        font-size: 12px;
        color: #9ca3af;
        white-space: nowrap;
      }
      .last-record-date.has-record {
        color: #6b7280;
      }
      .info-row {
        display: flex;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid #f3f4f6;
      }
      .info-row:last-child {
        border-bottom: none;
      }
      .info-label {
        width: 80px;
        font-size: 13px;
        color: #9ca3af;
        flex-shrink: 0;
      }
      .info-value {
        font-size: 14px;
        color: #1f2937;
        font-weight: 500;
        flex: 1;
      }
      .section-title {
        font-size: 15px;
        font-weight: 600;
        color: #374151;
        margin-bottom: 12px;
      }
      .record-date {
        font-size: 12px;
        color: #9ca3af;
        margin-bottom: 4px;
      }
      .record-note {
        font-size: 14px;
        color: #374151;
        line-height: 1.6;
        margin-top: 4px;
      }
      .empty-hint {
        text-align: center;
        color: #9ca3af;
        font-size: 14px;
        padding: 24px 0;
      }
      .content-with-bottom-btn {
        padding-bottom: 80px;
      }
      .bottom-fixed-btn {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        padding: 16px;
        background: linear-gradient(to top, #f8fafc 70%, transparent);
      }
      .bottom-fixed-btn-inner {
        max-width: 800px;
        margin: 0 auto;
      }
      .tag-chips-area {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 4px;
      }
      .phase2-buttons {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }
      .record-textarea {
        width: 100%;
        padding: 12px;
        border: 2px solid #e5e7eb;
        border-radius: 12px;
        font-size: 14px;
        font-family: "Noto Sans TC", sans-serif;
        line-height: 1.6;
        outline: none;
        resize: vertical;
        min-height: 96px;
        transition: border-color 0.2s ease;
        color: #1f2937;
        box-sizing: border-box;
      }
      .record-textarea:focus {
        border-color: #6366f1;
      }
      .form-section {
        margin-bottom: 16px;
      }
      .form-label {
        font-size: 14px;
        font-weight: 600;
        color: #374151;
        margin-bottom: 8px;
        display: block;
      }
      .student-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .search-wrapper {
        margin-bottom: 16px;
      }
      .records-section {
        margin-top: 16px;
      }
    </style>
  </head>
  <body>
    <!-- ç‹€æ…‹ 1ï¼šå­¸ç”Ÿåˆ—è¡¨ -->
    <div id="view-list" class="view active">
      <div class="page-container">
        <div class="page-header">
          <a href="index.html" class="nav-back">â† å›åˆ°é¦–é </a>
          <h1 class="page-title">å€‹æ¡ˆæœå‹™ç´€éŒ„</h1>
        </div>
        <div class="search-wrapper">
          <input
            type="text"
            id="search-input"
            class="search-input"
            placeholder="æœå°‹å­¸ç”Ÿå§“å..."
            oninput="handleSearch(this.value)"
          />
        </div>
        <div id="student-list" class="student-list fade-in"></div>
        <div id="no-results" class="empty-hint" style="display: none">
          æ‰¾ä¸åˆ°ç¬¦åˆã€Œ<span id="search-keyword"></span>ã€çš„å­¸ç”Ÿ
        </div>
      </div>
    </div>

    <!-- ç‹€æ…‹ 2ï¼šå­¸ç”Ÿå€‹åˆ¥é é¢ -->
    <div id="view-profile" class="view">
      <div class="page-container content-with-bottom-btn">
        <div class="page-header">
          <span
            class="nav-back"
            onclick="showView('list')"
            style="cursor: pointer"
            >â† è¿”å›åˆ—è¡¨</span
          >
          <h1 class="page-title" id="profile-name">å­¸ç”Ÿåå­—</h1>
        </div>
        <div class="card" style="margin-bottom: 16px">
          <div class="info-row">
            <span class="info-label">ç­ç´š</span>
            <span class="info-value" id="profile-class">â€”</span>
          </div>
          <div class="info-row">
            <span class="info-label">å¹´ç´š</span>
            <span class="info-value" id="profile-grade">â€”</span>
          </div>
          <div
            class="info-row"
            style="align-items: flex-start; padding-top: 10px"
          >
            <span class="info-label" style="padding-top: 2px">é—œæ³¨æ¨™ç±¤</span>
            <div id="profile-tags" class="tags-group">â€”</div>
          </div>
        </div>
        <div class="records-section">
          <h2 class="section-title">è¿‘æœŸç´€éŒ„</h2>
          <div class="card">
            <div id="profile-records"></div>
          </div>
        </div>
      </div>
      <div class="bottom-fixed-btn">
        <div class="bottom-fixed-btn-inner">
          <button
            class="btn-primary"
            style="width: 100%"
            onclick="goToNewRecord()"
          >
            ï¼‹ æ–°å¢ç´€éŒ„
          </button>
        </div>
      </div>
    </div>

    <!-- ç‹€æ…‹ 3ï¼šæ–°å¢ç´€éŒ„ -->
    <div id="view-new-record" class="view">
      <div class="page-container content-with-bottom-btn">
        <div class="page-header">
          <span
            class="nav-back"
            onclick="showView('profile')"
            style="cursor: pointer"
            >â† è¿”å›</span
          >
          <h1 class="page-title">
            æ–°å¢ç´€éŒ„ â€” <span id="new-record-name">å­¸ç”Ÿåå­—</span>
          </h1>
        </div>
        <div class="form-section card">
          <label class="form-label">è§€å¯Ÿé¢å‘ï¼ˆå¯å¤šé¸ï¼‰</label>
          <div id="tag-chips-area" class="tag-chips-area"></div>
        </div>
        <div class="form-section card">
          <label class="form-label" for="record-note">è§€å¯Ÿç´€éŒ„</label>
          <textarea
            id="record-note"
            class="record-textarea"
            rows="4"
            placeholder="è«‹è¼¸å…¥è§€å¯Ÿç´€éŒ„..."
          ></textarea>
        </div>
        <div class="form-section card">
          <label class="form-label" style="color: #9ca3af"
            >Phase 2 åŠŸèƒ½é å‘Š</label
          >
          <div class="phase2-buttons">
            <button class="btn-phase2">ğŸ¤ èªéŸ³è¼¸å…¥</button>
            <button class="btn-phase2">ğŸ¤– AI è¼”åŠ©æ•´ç†</button>
          </div>
        </div>
      </div>
      <div class="bottom-fixed-btn">
        <div class="bottom-fixed-btn-inner">
          <button
            class="btn-primary"
            style="width: 100%"
            onclick="saveRecord()"
          >
            âœ… å„²å­˜ç´€éŒ„
          </button>
        </div>
      </div>
    </div>

    <script src="shared.js"></script>
    <script>
      /* ç›®å‰é¸ä¸­çš„å­¸ç”Ÿ */
      let currentStudent = null;

      /* åˆ‡æ›ç•«é¢ç‹€æ…‹ */
      function showView(viewName) {
        document.querySelectorAll(".view").forEach(function (v) {
          v.classList.remove("active");
        });
        var targetView = document.getElementById("view-" + viewName);
        if (targetView) {
          targetView.classList.add("active");
          window.scrollTo(0, 0);
        }
      }

      /* æ¸²æŸ“å­¸ç”Ÿåˆ—è¡¨ï¼Œæ”¯æ´æœå°‹éæ¿¾ */
      function renderStudentList(filterText) {
        filterText = filterText || "";
        var allStudents = getAllStudents();
        var listContainer = document.getElementById("student-list");
        var noResults = document.getElementById("no-results");
        var searchKeyword = document.getElementById("search-keyword");

        var filtered = filterText
          ? allStudents.filter(function (s) {
              return s.name.indexOf(filterText.trim()) !== -1;
            })
          : allStudents;

        if (filtered.length === 0) {
          listContainer.innerHTML = "";
          noResults.style.display = "block";
          searchKeyword.textContent = filterText;
          return;
        }
        noResults.style.display = "none";

        var html = "";
        for (var i = 0; i < filtered.length; i++) {
          var student = filtered[i];
          var records = getStudentRecords(student.id);
          var latestDate = null;
          if (records.length > 0) {
            var sorted = records.slice().sort(function (a, b) {
              return b.date.localeCompare(a.date);
            });
            latestDate = sorted[0].date;
          }
          var dateDisplay = latestDate
            ? latestDate.replace(/^\d{4}-0?(\d+)-0?(\d+)$/, "$1/$2")
            : null;

          var tagsHtml = "";
          if (student.tags && student.tags.length > 0) {
            for (var t = 0; t < student.tags.length; t++) {
              tagsHtml +=
                '<span class="tag-small">' + student.tags[t] + "</span>";
            }
          }

          html +=
            '<div class="card card-clickable" onclick="goToProfile(\'' +
            student.id +
            "')\">";
          html +=
            '<div class="student-card-content"><div class="student-card-name">' +
            student.name +
            "</div>";
          html +=
            '<div class="student-card-class">' + student.className + "</div>";
          html +=
            '<div class="student-card-footer"><div class="tags-group">' +
            tagsHtml +
            "</div>";
          html +=
            '<span class="last-record-date' +
            (latestDate ? " has-record" : "") +
            '">' +
            (latestDate ? "æœ€è¿‘ï¼š" + dateDisplay : "å°šç„¡ç´€éŒ„") +
            "</span>";
          html += "</div></div></div>";
        }
        listContainer.innerHTML = html;
      }

      /* æœå°‹è™•ç† */
      function handleSearch(value) {
        renderStudentList(value);
      }

      /* é€²å…¥å­¸ç”Ÿå€‹åˆ¥é é¢ */
      function goToProfile(studentId) {
        var allStudents = getAllStudents();
        currentStudent = null;
        for (var i = 0; i < allStudents.length; i++) {
          if (allStudents[i].id === studentId) {
            currentStudent = allStudents[i];
            break;
          }
        }
        if (!currentStudent) return;

        document.getElementById("profile-name").textContent =
          currentStudent.name;
        document.getElementById("profile-class").textContent =
          currentStudent.className;
        document.getElementById("profile-grade").textContent =
          currentStudent.grade;

        var tagsContainer = document.getElementById("profile-tags");
        if (currentStudent.tags && currentStudent.tags.length > 0) {
          var tagsHtml = "";
          for (var t = 0; t < currentStudent.tags.length; t++) {
            tagsHtml +=
              '<span class="tag-small">' + currentStudent.tags[t] + "</span>";
          }
          tagsContainer.innerHTML = tagsHtml;
        } else {
          tagsContainer.innerHTML =
            '<span style="color: #9ca3af; font-size: 14px;">ç„¡ç‰¹æ®Šæ¨™è¨˜</span>';
        }

        renderProfileRecords(studentId);
        showView("profile");
      }

      /* æ¸²æŸ“å­¸ç”Ÿçš„æ­·å²ç´€éŒ„ï¼ˆæ™‚é–“è»¸æ ¼å¼ï¼‰ */
      function renderProfileRecords(studentId) {
        var records = getStudentRecords(studentId);
        var recordsContainer = document.getElementById("profile-records");

        if (records.length === 0) {
          recordsContainer.innerHTML =
            '<div class="empty-hint">å°šç„¡æœå‹™ç´€éŒ„</div>';
          return;
        }

        var sorted = records.slice().sort(function (a, b) {
          return b.date.localeCompare(a.date);
        });

        var html = '<div class="record-timeline">';
        for (var i = 0; i < sorted.length; i++) {
          var record = sorted[i];
          html += '<div class="record-item">';
          html +=
            '<div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">';
          html +=
            '<span class="record-date">' + formatDate(record.date) + "</span>";
          html += '<span class="tag-small">' + record.category + "</span>";
          html += '</div><p class="record-note">' + record.note + "</p></div>";
        }
        html += "</div>";
        recordsContainer.innerHTML = html;
      }

      /* æ—¥æœŸæ ¼å¼åŒ–ï¼š2026-02-22 â†’ 2/22 */
      function formatDate(dateStr) {
        return dateStr.replace(/^\d{4}-0?(\d+)-0?(\d+)$/, "$1/$2");
      }

      /* é€²å…¥æ–°å¢ç´€éŒ„ç•«é¢ */
      function goToNewRecord() {
        if (!currentStudent) return;
        document.getElementById("new-record-name").textContent =
          currentStudent.name;
        document.getElementById("record-note").value = "";

        var tagArea = document.getElementById("tag-chips-area");
        var tagHtml = "";
        for (var i = 0; i < OBSERVATION_TAGS.length; i++) {
          tagHtml +=
            '<span class="tag-chip" onclick="toggleTag(this)">' +
            OBSERVATION_TAGS[i] +
            "</span>";
        }
        tagArea.innerHTML = tagHtml;
        showView("new-record");
      }

      /* åˆ‡æ›è§€å¯Ÿé¢å‘æ¨™ç±¤é¸å–ç‹€æ…‹ */
      function toggleTag(element) {
        element.classList.toggle("selected");
      }

      /* å„²å­˜æ–°ç´€éŒ„ï¼ˆå­˜åœ¨è¨˜æ†¶é«”ä¸­ï¼‰ */
      function saveRecord() {
        var selectedEls = document.querySelectorAll(
          "#tag-chips-area .tag-chip.selected",
        );
        var selectedTags = [];
        for (var i = 0; i < selectedEls.length; i++) {
          selectedTags.push(selectedEls[i].textContent.trim());
        }
        var note = document.getElementById("record-note").value.trim();

        if (selectedTags.length === 0) {
          showToast("è«‹è‡³å°‘é¸æ“‡ä¸€å€‹è§€å¯Ÿé¢å‘");
          return;
        }
        if (!note) {
          showToast("è«‹è¼¸å…¥è§€å¯Ÿç´€éŒ„å…§å®¹");
          return;
        }

        var today = new Date().toISOString().split("T")[0];
        var newRecord = {
          date: today,
          category: selectedTags.join("ã€"),
          note: note,
        };

        var studentId = currentStudent.id;
        if (!CASE_RECORDS[studentId]) {
          CASE_RECORDS[studentId] = [];
        }
        CASE_RECORDS[studentId].unshift(newRecord);

        showToast("ç´€éŒ„å·²å„²å­˜");
        renderProfileRecords(studentId);
        showView("profile");
      }

      /* é é¢è¼‰å…¥æ™‚æ¸²æŸ“å­¸ç”Ÿåˆ—è¡¨ */
      document.addEventListener("DOMContentLoaded", function () {
        renderStudentList();
      });
    </script>
  </body>
</html>
