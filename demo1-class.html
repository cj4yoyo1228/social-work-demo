<!doctype html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>班級點名 - 永齡希望小學</title>

    <!-- Google Fonts：Noto Sans TC 中文字體 -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <script>
      // 設定 Tailwind 自訂顏色與字體
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: "#00897B",
            },
            fontFamily: {
              sans: ["Noto Sans TC", "sans-serif"],
            },
          },
        },
      };
    </script>

    <style>
      /* 全域字體設定 */
      * {
        font-family: "Noto Sans TC", sans-serif;
        box-sizing: border-box;
      }

      /* 頁面背景：深藍紫色，營造手機展示感 */
      body {
        background: linear-gradient(135deg, #1a1a3e 0%, #2d1b69 100%);
        min-height: 100vh;
        display: flex;
        align-items: flex-start;
        justify-content: center;
        padding: 40px 16px 60px;
      }

      /* ── 手機外框 ── */
      .phone-shell {
        width: 390px;
        background: #111827;
        border-radius: 52px;
        padding: 16px;
        box-shadow:
          0 0 0 1px rgba(255, 255, 255, 0.06),
          0 0 0 3px #0d0d1a,
          0 40px 100px rgba(0, 0, 0, 0.6),
          inset 0 1px 0 rgba(255, 255, 255, 0.05);
        position: relative;
      }

      /* 右側電源按鈕（裝飾） */
      .phone-shell::before {
        content: "";
        position: absolute;
        right: -4px;
        top: 140px;
        width: 4px;
        height: 68px;
        background: #1f2937;
        border-radius: 0 3px 3px 0;
      }

      /* 左側音量按鈕（裝飾） */
      .phone-shell::after {
        content: "";
        position: absolute;
        left: -4px;
        top: 110px;
        width: 4px;
        height: 38px;
        background: #1f2937;
        border-radius: 3px 0 0 3px;
        box-shadow:
          0 56px 0 #1f2937,
          0 108px 0 #1f2937;
      }

      /* ── 手機螢幕區域 ── */
      .phone-screen {
        width: 100%;
        min-height: 800px;
        background: #f0faf9;
        border-radius: 38px;
        overflow: hidden;
        position: relative;
      }

      /* ── 頂部狀態列（仿 iPhone 動態島） ── */
      .status-bar {
        background: #f0faf9;
        padding: 14px 28px 10px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        font-size: 13px;
        font-weight: 700;
        color: #1f2937;
        position: relative;
      }

      /* 動態島膠囊 */
      .dynamic-island {
        position: absolute;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        width: 120px;
        height: 34px;
        background: #111827;
        border-radius: 20px;
        display: flex;
        align-items: center;
        justify-content: flex-end;
        padding-right: 10px;
        gap: 6px;
      }

      /* 相機小點 */
      .camera-dot {
        width: 10px;
        height: 10px;
        background: #1a2335;
        border-radius: 50%;
        border: 1.5px solid #2d3748;
      }

      /* ── 畫面滾動區域 ── */
      .content-area {
        height: calc(800px - 60px);
        overflow-y: auto;
        scrollbar-width: none;
        background: #f0faf9;
      }
      .content-area::-webkit-scrollbar {
        display: none;
      }

      /* ══════════════════════════
       畫面切換動畫
    ══════════════════════════ */

      /* 進入動畫：從下方淡入滑上 */
      @keyframes fadeSlideUp {
        from {
          opacity: 0;
          transform: translateY(24px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* 簡單淡入 */
      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      /* 彈跳縮放 */
      @keyframes checkBounce {
        0% {
          transform: scale(0) rotate(-15deg);
        }
        55% {
          transform: scale(1.2) rotate(6deg);
        }
        75% {
          transform: scale(0.92) rotate(-3deg);
        }
        100% {
          transform: scale(1) rotate(0deg);
        }
      }

      /* 卡片依序進場 */
      @keyframes cardSlideIn {
        from {
          opacity: 0;
          transform: translateY(18px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* 所有畫面預設隱藏 */
      .screen {
        display: none;
      }

      /* 啟用的畫面 */
      .screen.active {
        display: block;
        animation: fadeSlideUp 0.4s cubic-bezier(0.23, 1, 0.32, 1) forwards;
      }

      /* 班級卡片進場（延遲） */
      .class-card {
        animation: cardSlideIn 0.35s ease forwards;
        opacity: 0;
      }
      .class-card:nth-child(2) {
        animation-delay: 0.06s;
      }
      .class-card:nth-child(3) {
        animation-delay: 0.14s;
      }
      .class-card:nth-child(4) {
        animation-delay: 0.22s;
      }

      /* ══════════════════════════
       按鈕樣式
    ══════════════════════════ */

      /* 主按鈕：青綠色漸層 */
      .btn-primary {
        background: linear-gradient(135deg, #00897b 0%, #26a69a 100%);
        color: white;
        border-radius: 14px;
        padding: 14px;
        font-size: 15px;
        font-weight: 600;
        width: 100%;
        border: none;
        cursor: pointer;
        letter-spacing: 0.3px;
        transition:
          transform 0.12s ease,
          box-shadow 0.12s ease,
          background 0.15s ease;
        box-shadow: 0 2px 8px rgba(0, 137, 123, 0.2);
      }
      .btn-primary:active {
        transform: scale(0.965);
        box-shadow: 0 2px 8px rgba(0, 137, 123, 0.25);
        background: #00695c;
      }
      .btn-primary:disabled {
        background: #e5e7eb;
        color: #9ca3af;
        box-shadow: none;
        cursor: default;
      }

      /* 次要按鈕：白底青綠框 */
      .btn-secondary {
        background: white;
        color: #00897b;
        border: 2px solid #00897b;
        border-radius: 14px;
        padding: 13px;
        font-size: 15px;
        font-weight: 600;
        width: 100%;
        cursor: pointer;
        letter-spacing: 0.3px;
        transition:
          transform 0.12s ease,
          background 0.15s ease;
      }
      .btn-secondary:active {
        transform: scale(0.965);
        background: #e0f2f1;
      }

      /* ══════════════════════════
       學生卡片
    ══════════════════════════ */

      .student-card {
        border-radius: 12px;
        padding: 13px 16px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        cursor: pointer;
        user-select: none;
        transition:
          transform 0.14s ease,
          box-shadow 0.14s ease;
      }
      .student-card:active {
        transform: scale(0.975);
      }

      /* 出席：綠色邊框 */
      .student-present {
        background: white;
        border: 2px solid #a7f3d0;
      }

      /* 缺席：玫瑰粉邊框 */
      .student-absent {
        background: #fff4fb;
        border: 2px solid #f9a8d4;
      }

      /* 缺席原因下拉選單 */
      .absence-select {
        border: 1.5px solid #f9a8d4;
        border-radius: 8px;
        padding: 5px 8px;
        font-size: 12px;
        font-family: "Noto Sans TC", sans-serif;
        font-weight: 600;
        color: #ec4899;
        background: white;
        cursor: pointer;
        outline: none;
        min-width: 64px;
      }
      .absence-select:focus {
        border-color: #ec4899;
        box-shadow: 0 0 0 3px rgba(236, 72, 153, 0.12);
      }

      /* ══════════════════════════
       進度條
    ══════════════════════════ */
      .progress-track {
        background: rgba(255, 255, 255, 0.25);
        border-radius: 999px;
        height: 7px;
        overflow: hidden;
      }
      .progress-fill {
        height: 100%;
        background: white;
        border-radius: 999px;
        transition: width 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
      }

      /* ══════════════════════════
       完成頁大勾勾
    ══════════════════════════ */
      .check-bounce {
        animation: checkBounce 0.55s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        display: inline-block;
      }

      /* ══════════════════════════
       日誌輸入框
    ══════════════════════════ */
      .journal-textarea {
        width: 100%;
        min-height: 130px;
        border: 2px solid #b2dfdb;
        border-radius: 12px;
        padding: 13px;
        font-size: 14px;
        font-family: "Noto Sans TC", sans-serif;
        line-height: 1.7;
        resize: none;
        outline: none;
        color: #374151;
        transition:
          border-color 0.2s ease,
          box-shadow 0.2s ease;
        background: white;
      }
      .journal-textarea:focus {
        border-color: #00897b;
        box-shadow: 0 0 0 3px rgba(0, 137, 123, 0.12);
      }
      .journal-textarea::placeholder {
        color: #c4c9d4;
        line-height: 1.7;
      }

      /* ══════════════════════════
         AI 引導日誌系統
      ══════════════════════════ */

      /* ── 進度圓點 ── */
      .journal-progress {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-bottom: 20px;
      }
      .progress-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: #e0e0e0;
        transition:
          background 0.3s ease,
          transform 0.3s ease;
      }
      .progress-dot.active {
        background: #6366f1;
        transform: scale(1.3);
      }
      .progress-dot.done {
        background: #10b981;
      }

      /* ── AI 提問泡泡 ── */
      .ai-bubble {
        display: flex;
        align-items: flex-start;
        gap: 10px;
        margin-bottom: 16px;
      }
      .ai-avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: linear-gradient(135deg, #6366f1, #818cf8);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        flex-shrink: 0;
      }
      .ai-question {
        background: #f0f0ff;
        border-radius: 0 12px 12px 12px;
        padding: 12px 14px;
        font-size: 14px;
        font-weight: 500;
        color: #374151;
        line-height: 1.6;
        flex: 1;
      }

      /* ── Emoji 快選按鈕 ── */
      .emoji-choices {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-bottom: 14px;
      }
      .emoji-btn {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 4px;
        padding: 14px 8px;
        border: 2px solid #e5e7eb;
        border-radius: 12px;
        background: white;
        cursor: pointer;
        font-size: 28px;
        transition:
          border-color 0.2s ease,
          background 0.2s ease,
          transform 0.12s ease;
      }
      .emoji-btn:hover {
        border-color: #a5b4fc;
        background: #f5f3ff;
      }
      .emoji-btn.selected {
        border-color: #6366f1;
        background: #eef2ff;
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15);
      }
      .emoji-btn:active {
        transform: scale(0.95);
      }

      /* ── Pill 標籤快選 ── */
      .tag-pill {
        display: inline-block;
        padding: 7px 14px;
        border: 1.5px solid #e5e7eb;
        border-radius: 20px;
        font-size: 13px;
        font-weight: 500;
        color: #6b7280;
        background: white;
        cursor: pointer;
        margin: 0 6px 8px 0;
        transition:
          border-color 0.2s ease,
          background 0.2s ease,
          color 0.2s ease;
      }
      .tag-pill:hover {
        border-color: #a5b4fc;
        color: #6366f1;
      }
      .tag-pill.selected {
        border-color: #6366f1;
        background: #eef2ff;
        color: #6366f1;
        font-weight: 600;
      }

      /* ── 步驟切換動畫 ── */
      .journal-step {
        display: none;
      }
      .journal-step.active {
        display: block;
        animation: journalFadeSlideUp 0.35s ease forwards;
      }

      @keyframes journalFadeSlideUp {
        from {
          opacity: 0;
          transform: translateY(16px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* ── 補充文字框 ── */
      .step-textarea {
        width: 100%;
        min-height: 72px;
        border: 2px solid #e5e7eb;
        border-radius: 10px;
        padding: 10px 12px;
        font-size: 13px;
        font-family: "Noto Sans TC", sans-serif;
        line-height: 1.6;
        resize: none;
        outline: none;
        color: #374151;
        background: white;
        transition:
          border-color 0.2s ease,
          box-shadow 0.2s ease;
        margin-top: 10px;
      }
      .step-textarea:focus {
        border-color: #6366f1;
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.12);
      }
      .step-textarea::placeholder {
        color: #c4c9d4;
      }

      /* ── 缺席學生關注卡片 ── */
      .concern-student {
        background: #fff7ed;
        border: 1.5px solid #fed7aa;
        border-radius: 10px;
        padding: 12px;
        margin-bottom: 10px;
      }
      .concern-student .name {
        font-size: 14px;
        font-weight: 700;
        color: #111827;
        margin-bottom: 6px;
      }
      .concern-student .tags {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-bottom: 8px;
      }

      /* ── 導航按鈕 ── */
      .step-nav {
        display: flex;
        gap: 10px;
        margin-top: 18px;
      }
      .btn-step-next {
        flex: 1;
        background: linear-gradient(135deg, #6366f1, #818cf8);
        color: white;
        border: none;
        border-radius: 10px;
        padding: 12px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition:
          transform 0.12s ease,
          opacity 0.2s ease;
        font-family: "Noto Sans TC", sans-serif;
      }
      .btn-step-next:hover {
        opacity: 0.9;
      }
      .btn-step-next:active {
        transform: scale(0.96);
      }
      .btn-step-next:disabled {
        background: #e5e7eb;
        color: #9ca3af;
        cursor: default;
      }
      .btn-step-skip {
        background: white;
        color: #9ca3af;
        border: 1.5px solid #e5e7eb;
        border-radius: 10px;
        padding: 12px 16px;
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        transition: background 0.15s ease;
        font-family: "Noto Sans TC", sans-serif;
      }
      .btn-step-skip:active {
        background: #f9fafb;
      }

      /* ── AI 組合預覽 ── */
      .journal-preview {
        background: #f9fafb;
        border: 1.5px solid #e5e7eb;
        border-radius: 12px;
        padding: 16px;
        font-size: 13px;
        line-height: 1.8;
        color: #374151;
        white-space: pre-wrap;
        word-break: break-word;
        max-height: 260px;
        overflow-y: auto;
      }
      .journal-preview[contenteditable] {
        cursor: text;
        outline: none;
      }
      .journal-preview[contenteditable]:focus {
        border-color: #6366f1;
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.12);
      }

      /* ── 新增學生按鈕 ── */
      .btn-add-student {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        width: 100%;
        padding: 10px;
        border: 2px dashed #c7d2fe;
        border-radius: 10px;
        background: white;
        color: #6366f1;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        transition:
          background 0.15s ease,
          border-color 0.15s ease;
        font-family: "Noto Sans TC", sans-serif;
        margin-top: 8px;
      }
      .btn-add-student:hover {
        background: #eef2ff;
        border-color: #6366f1;
      }

      /* ── 已完成班級的淡化效果 ── */
      .class-card.completed {
        opacity: 0.55;
        filter: grayscale(25%);
        cursor: default;
        pointer-events: none;
      }

      /* ── 帶圓點網格的 Header ── */
      .header-with-dots {
        position: relative;
        overflow: hidden;
      }
      /* 圓點網格背景（偽元素覆蓋在 header 上層） */
      .header-with-dots::before {
        content: "";
        position: absolute;
        inset: 0;
        background-image: radial-gradient(
          rgba(255, 255, 255, 0.1) 1px,
          transparent 1px
        );
        background-size: 20px 20px;
        pointer-events: none;
        z-index: 0;
      }
      /* 確保 header 內的所有子元素顯示在圓點網格上方 */
      .header-with-dots > * {
        position: relative;
        z-index: 1;
      }

      /* ── 底部固定操作列 ── */
      .bottom-bar {
        position: sticky;
        bottom: 0;
        left: 0;
        right: 0;
        padding: 14px 20px 24px;
        background: linear-gradient(to top, white 70%, transparent);
        z-index: 50;
      }
    </style>
  </head>

  <body>
    <!-- ═══════════════════════════
       手機外框
  ═══════════════════════════ -->
    <div class="phone-shell">
      <div class="phone-screen">
        <!-- 狀態列（仿動態島） -->
        <div class="status-bar">
          <span id="statusTime" style="font-size: 14px; font-weight: 700"
            >09:41</span
          >
          <!-- 動態島 -->
          <div class="dynamic-island">
            <div class="camera-dot"></div>
          </div>
          <!-- 右側系統圖示 -->
          <div
            style="
              display: flex;
              align-items: center;
              gap: 5px;
              font-size: 13px;
            "
          >
            <span>📶</span>
            <span>🔋</span>
          </div>
        </div>

        <!-- 主內容滾動區域 -->
        <div class="content-area">
          <!-- ═══════════════════════════════════════════
             畫面 1：今日任務列表
        ════════════════════════════════════════════ -->
          <div
            id="screen-home"
            class="screen active"
            style="padding-bottom: 36px"
          >
            <!-- 頂部漸層問候 Header -->
            <div
              class="header-with-dots"
              style="
                background: linear-gradient(
                  135deg,
                  #004d40 0%,
                  #00897b 50%,
                  #26a69a 100%
                );
                padding: 22px 22px 32px;
                border-radius: 0 0 32px 32px;
              "
            >
              <!-- 裝飾性背景圓圈 -->
              <div
                style="
                  position: absolute;
                  top: -40px;
                  right: -40px;
                  width: 160px;
                  height: 160px;
                  background: rgba(255, 255, 255, 0.07);
                  border-radius: 50%;
                  pointer-events: none;
                "
              ></div>
              <div
                style="
                  position: absolute;
                  bottom: -50px;
                  left: -20px;
                  width: 120px;
                  height: 120px;
                  background: rgba(255, 255, 255, 0.05);
                  border-radius: 50%;
                  pointer-events: none;
                "
              ></div>

              <!-- 問候語 + 姓名 -->
              <p
                id="greeting"
                style="
                  color: rgba(255, 255, 255, 0.8);
                  font-size: 13px;
                  font-weight: 400;
                  margin-bottom: 5px;
                  letter-spacing: 0.3px;
                "
              ></p>
              <h1
                style="
                  color: white;
                  font-size: 20px;
                  font-weight: 700;
                  line-height: 1.4;
                  margin-bottom: 0;
                "
              >
                嗨，小明！<br />今天有 3 個班級等你 💪
              </h1>

              <!-- 今日日期 -->
              <div
                style="
                  margin-top: 14px;
                  display: flex;
                  align-items: center;
                  gap: 8px;
                "
              >
                <span style="font-size: 16px">📅</span>
                <p
                  id="todayDate"
                  style="
                    color: rgba(255, 255, 255, 0.75);
                    font-size: 13px;
                    font-weight: 400;
                  "
                ></p>
              </div>
            </div>

            <!-- 課程列表 -->
            <div
              style="
                padding: 18px 16px;
                display: flex;
                flex-direction: column;
                gap: 14px;
              "
            >
              <p
                style="
                  font-size: 11px;
                  font-weight: 600;
                  color: #9ca3af;
                  letter-spacing: 1.5px;
                  text-transform: uppercase;
                  padding-left: 2px;
                "
              >
                今日課程
              </p>

              <!-- 班級卡片 1 -->
              <div
                class="class-card"
                id="card-0"
                style="
                  background: white;
                  border-radius: 18px;
                  padding: 18px 18px 14px;
                  box-shadow: 0 2px 14px rgba(0, 0, 0, 0.06);
                "
              >
                <div
                  style="
                    display: flex;
                    justify-content: space-between;
                    align-items: flex-start;
                    margin-bottom: 14px;
                  "
                >
                  <!-- 左側：班級資訊 -->
                  <div style="flex: 1">
                    <div
                      style="
                        display: flex;
                        align-items: center;
                        gap: 8px;
                        margin-bottom: 6px;
                      "
                    >
                      <div
                        style="
                          width: 32px;
                          height: 32px;
                          background: linear-gradient(135deg, #e0f2f1, #b2dfdb);
                          border-radius: 10px;
                          display: flex;
                          align-items: center;
                          justify-content: center;
                          font-size: 16px;
                        "
                      >
                        🏫
                      </div>
                      <h3
                        style="
                          font-size: 16px;
                          font-weight: 700;
                          color: #111827;
                        "
                      >
                        光明國小 A班
                      </h3>
                    </div>
                    <div style="display: flex; align-items: center; gap: 12px">
                      <span
                        style="
                          font-size: 12px;
                          color: #6b7280;
                          display: flex;
                          align-items: center;
                          gap: 3px;
                        "
                        >🕐 09:00 - 11:00</span
                      >
                      <span
                        style="
                          font-size: 12px;
                          color: #6b7280;
                          display: flex;
                          align-items: center;
                          gap: 3px;
                        "
                        >👥 12 人</span
                      >
                    </div>
                  </div>
                  <!-- 右側：狀態標籤 -->
                  <div
                    id="status-badge-0"
                    style="
                      background: #fef9c3;
                      color: #a16207;
                      font-size: 11px;
                      font-weight: 700;
                      padding: 5px 11px;
                      border-radius: 20px;
                      white-space: nowrap;
                      letter-spacing: 0.3px;
                    "
                  >
                    未點名
                  </div>
                </div>
                <button
                  id="action-btn-0"
                  class="btn-primary"
                  style="font-size: 14px; padding: 12px"
                  onclick="startRoll(0)"
                >
                  開始點名 →
                </button>
              </div>

              <!-- 班級卡片 2 -->
              <div
                class="class-card"
                id="card-1"
                style="
                  background: white;
                  border-radius: 18px;
                  padding: 18px 18px 14px;
                  box-shadow: 0 2px 14px rgba(0, 0, 0, 0.06);
                "
              >
                <div
                  style="
                    display: flex;
                    justify-content: space-between;
                    align-items: flex-start;
                    margin-bottom: 14px;
                  "
                >
                  <div style="flex: 1">
                    <div
                      style="
                        display: flex;
                        align-items: center;
                        gap: 8px;
                        margin-bottom: 6px;
                      "
                    >
                      <div
                        style="
                          width: 32px;
                          height: 32px;
                          background: linear-gradient(135deg, #e0f2f1, #b2dfdb);
                          border-radius: 10px;
                          display: flex;
                          align-items: center;
                          justify-content: center;
                          font-size: 16px;
                        "
                      >
                        🏫
                      </div>
                      <h3
                        style="
                          font-size: 16px;
                          font-weight: 700;
                          color: #111827;
                        "
                      >
                        希望國小 B班
                      </h3>
                    </div>
                    <div style="display: flex; align-items: center; gap: 12px">
                      <span style="font-size: 12px; color: #6b7280"
                        >🕑 14:00 - 16:00</span
                      >
                      <span style="font-size: 12px; color: #6b7280"
                        >👥 15 人</span
                      >
                    </div>
                  </div>
                  <div
                    id="status-badge-1"
                    style="
                      background: #fef9c3;
                      color: #a16207;
                      font-size: 11px;
                      font-weight: 700;
                      padding: 5px 11px;
                      border-radius: 20px;
                      white-space: nowrap;
                      letter-spacing: 0.3px;
                    "
                  >
                    未點名
                  </div>
                </div>
                <button
                  id="action-btn-1"
                  class="btn-primary"
                  style="font-size: 14px; padding: 12px"
                  onclick="startRoll(1)"
                >
                  開始點名 →
                </button>
              </div>

              <!-- 班級卡片 3 -->
              <div
                class="class-card"
                id="card-2"
                style="
                  background: white;
                  border-radius: 18px;
                  padding: 18px 18px 14px;
                  box-shadow: 0 2px 14px rgba(0, 0, 0, 0.06);
                "
              >
                <div
                  style="
                    display: flex;
                    justify-content: space-between;
                    align-items: flex-start;
                    margin-bottom: 14px;
                  "
                >
                  <div style="flex: 1">
                    <div
                      style="
                        display: flex;
                        align-items: center;
                        gap: 8px;
                        margin-bottom: 6px;
                      "
                    >
                      <div
                        style="
                          width: 32px;
                          height: 32px;
                          background: linear-gradient(135deg, #e0f2f1, #b2dfdb);
                          border-radius: 10px;
                          display: flex;
                          align-items: center;
                          justify-content: center;
                          font-size: 16px;
                        "
                      >
                        🏫
                      </div>
                      <h3
                        style="
                          font-size: 16px;
                          font-weight: 700;
                          color: #111827;
                        "
                      >
                        陽光國小 C班
                      </h3>
                    </div>
                    <div style="display: flex; align-items: center; gap: 12px">
                      <span style="font-size: 12px; color: #6b7280"
                        >🕤 09:30 - 11:30</span
                      >
                      <span style="font-size: 12px; color: #6b7280"
                        >👥 10 人</span
                      >
                    </div>
                  </div>
                  <div
                    id="status-badge-2"
                    style="
                      background: #fef9c3;
                      color: #a16207;
                      font-size: 11px;
                      font-weight: 700;
                      padding: 5px 11px;
                      border-radius: 20px;
                      white-space: nowrap;
                      letter-spacing: 0.3px;
                    "
                  >
                    未點名
                  </div>
                </div>
                <button
                  id="action-btn-2"
                  class="btn-primary"
                  style="font-size: 14px; padding: 12px"
                  onclick="startRoll(2)"
                >
                  開始點名 →
                </button>
              </div>

              <!-- 底部提示 -->
              <p
                style="
                  text-align: center;
                  font-size: 12px;
                  color: #cbd5e1;
                  padding-top: 6px;
                "
              >
                點擊卡片開始點名
              </p>
            </div>
          </div>

          <!-- ═══════════════════════════════════════════
             畫面 2：點名畫面
        ════════════════════════════════════════════ -->
          <div id="screen-roll" class="screen" style="padding-bottom: 90px">
            <!-- 頂部 Header（漸層） -->
            <div
              class="header-with-dots"
              style="
                background: linear-gradient(
                  135deg,
                  #004d40 0%,
                  #00897b 50%,
                  #26a69a 100%
                );
                padding: 18px 20px 26px;
                border-radius: 0 0 28px 28px;
              "
            >
              <!-- 裝飾圓圈 -->
              <div
                style="
                  position: absolute;
                  top: -30px;
                  right: -30px;
                  width: 110px;
                  height: 110px;
                  background: rgba(255, 255, 255, 0.07);
                  border-radius: 50%;
                  pointer-events: none;
                "
              ></div>

              <!-- 返回按鈕 -->
              <button
                onclick="goHome()"
                style="
                  background: rgba(255, 255, 255, 0.18);
                  border: none;
                  color: white;
                  border-radius: 10px;
                  padding: 7px 13px;
                  font-size: 13px;
                  font-weight: 600;
                  cursor: pointer;
                  margin-bottom: 14px;
                  display: inline-flex;
                  align-items: center;
                  gap: 4px;
                  letter-spacing: 0.2px;
                  transition: background 0.15s;
                "
              >
                ← 返回
              </button>

              <!-- 班級名稱 -->
              <h2
                id="roll-class-name"
                style="
                  color: white;
                  font-size: 19px;
                  font-weight: 700;
                  margin-bottom: 10px;
                "
              ></h2>

              <!-- 出席計數 + 百分比 -->
              <div
                style="
                  display: flex;
                  align-items: flex-end;
                  justify-content: space-between;
                  margin-bottom: 12px;
                "
              >
                <div>
                  <p
                    style="
                      color: rgba(255, 255, 255, 0.75);
                      font-size: 12px;
                      margin-bottom: 3px;
                      letter-spacing: 0.3px;
                    "
                  >
                    目前出席
                  </p>
                  <div style="display: flex; align-items: baseline; gap: 4px">
                    <span
                      id="present-count"
                      style="
                        font-size: 42px;
                        font-weight: 800;
                        color: white;
                        line-height: 1;
                        letter-spacing: -1px;
                      "
                    ></span>
                    <span
                      id="total-count"
                      style="
                        font-size: 16px;
                        font-weight: 500;
                        color: rgba(255, 255, 255, 0.65);
                      "
                    ></span>
                  </div>
                </div>
                <div style="text-align: right">
                  <p
                    style="
                      color: rgba(255, 255, 255, 0.75);
                      font-size: 12px;
                      margin-bottom: 3px;
                    "
                  >
                    出席率
                  </p>
                  <p
                    id="percent-display"
                    style="
                      font-size: 26px;
                      font-weight: 800;
                      color: white;
                      line-height: 1;
                    "
                  ></p>
                </div>
              </div>

              <!-- 進度條 -->
              <div class="progress-track">
                <div
                  id="roll-progress-bar"
                  class="progress-fill"
                  style="width: 100%"
                ></div>
              </div>
            </div>

            <!-- 學生列表 -->
            <div
              id="student-list"
              style="
                padding: 14px 14px;
                display: flex;
                flex-direction: column;
                gap: 9px;
              "
            >
              <!-- 由 JS 動態渲染 -->
            </div>

            <!-- 底部固定：完成點名按鈕 -->
            <div class="bottom-bar">
              <button
                class="btn-primary"
                onclick="finishRoll()"
                style="font-size: 16px; padding: 16px; letter-spacing: 0.5px"
              >
                完成點名 ✅
              </button>
            </div>
          </div>

          <!-- ═══════════════════════════════════════════
             畫面 3：點名完成 + 日誌入口
        ════════════════════════════════════════════ -->
          <div id="screen-done" class="screen" style="padding: 28px 18px 48px">
            <!-- 大勾勾 + 標題 -->
            <div style="text-align: center; padding: 16px 0 28px">
              <div class="check-bounce" style="font-size: 76px; line-height: 1">
                ✅
              </div>
              <h2
                style="
                  font-size: 26px;
                  font-weight: 800;
                  color: #111827;
                  margin-top: 14px;
                  letter-spacing: -0.3px;
                "
              >
                點名完成！
              </h2>
              <p
                id="done-class-name"
                style="
                  font-size: 13px;
                  color: #9ca3af;
                  margin-top: 5px;
                  font-weight: 400;
                "
              ></p>
            </div>

            <!-- 統計摘要卡片 -->
            <div
              style="
                background: white;
                border-radius: 18px;
                padding: 20px;
                box-shadow: 0 2px 14px rgba(0, 0, 0, 0.07);
                margin-bottom: 16px;
              "
            >
              <p
                style="
                  font-size: 11px;
                  font-weight: 600;
                  color: #9ca3af;
                  letter-spacing: 1.5px;
                  text-transform: uppercase;
                  margin-bottom: 16px;
                "
              >
                出席統計
              </p>
              <div
                style="
                  display: flex;
                  justify-content: space-around;
                  text-align: center;
                "
              >
                <!-- 出席 -->
                <div>
                  <div
                    id="done-present"
                    style="
                      font-size: 36px;
                      font-weight: 800;
                      color: #10b981;
                      letter-spacing: -1px;
                      line-height: 1;
                    "
                  ></div>
                  <p
                    style="
                      font-size: 12px;
                      color: #9ca3af;
                      margin-top: 5px;
                      font-weight: 500;
                    "
                  >
                    出席
                  </p>
                </div>
                <div style="width: 1px; background: #f1f5f9"></div>
                <!-- 缺席 -->
                <div>
                  <div
                    id="done-absent"
                    style="
                      font-size: 36px;
                      font-weight: 800;
                      color: #ec4899;
                      letter-spacing: -1px;
                      line-height: 1;
                    "
                  ></div>
                  <p
                    style="
                      font-size: 12px;
                      color: #9ca3af;
                      margin-top: 5px;
                      font-weight: 500;
                    "
                  >
                    缺席
                  </p>
                </div>
                <div style="width: 1px; background: #f1f5f9"></div>
                <!-- 總計 -->
                <div>
                  <div
                    id="done-total"
                    style="
                      font-size: 36px;
                      font-weight: 800;
                      color: #00897b;
                      letter-spacing: -1px;
                      line-height: 1;
                    "
                  ></div>
                  <p
                    style="
                      font-size: 12px;
                      color: #9ca3af;
                      margin-top: 5px;
                      font-weight: 500;
                    "
                  >
                    總計
                  </p>
                </div>
              </div>
            </div>

            <!-- 缺席名單（有缺席才顯示） -->
            <div
              id="absent-list-section"
              style="
                background: white;
                border-radius: 18px;
                padding: 18px;
                box-shadow: 0 2px 14px rgba(0, 0, 0, 0.07);
                margin-bottom: 16px;
                display: none;
              "
            >
              <p
                style="
                  font-size: 11px;
                  font-weight: 600;
                  color: #9ca3af;
                  letter-spacing: 1.5px;
                  text-transform: uppercase;
                  margin-bottom: 12px;
                "
              >
                ⚠️ 缺席名單
              </p>
              <div
                id="absent-list-content"
                style="display: flex; flex-direction: column; gap: 8px"
              ></div>
            </div>

            <!-- AI 引導日誌系統 -->
            <div
              id="journal-section"
              style="
                background: white;
                border-radius: 18px;
                padding: 18px;
                box-shadow: 0 2px 14px rgba(0, 0, 0, 0.07);
                margin-bottom: 14px;
              "
            >
              <p
                style="
                  font-size: 11px;
                  font-weight: 600;
                  color: #9ca3af;
                  letter-spacing: 1.5px;
                  text-transform: uppercase;
                  margin-bottom: 14px;
                "
              >
                今日日誌
              </p>

              <!-- 入口按鈕 -->
              <div id="journal-trigger">
                <button
                  class="btn-step-next"
                  onclick="startJournalGuide()"
                  style="
                    width: 100%;
                    padding: 14px;
                    font-size: 15px;
                    border-radius: 12px;
                  "
                >
                  🤖 AI 幫我寫日誌
                </button>
              </div>

              <!-- 引導流程容器 -->
              <div id="journal-guide" style="display: none">
                <!-- 進度圓點 -->
                <div class="journal-progress">
                  <div class="progress-dot active" id="dot-0"></div>
                  <div class="progress-dot" id="dot-1"></div>
                  <div class="progress-dot" id="dot-2"></div>
                  <div class="progress-dot" id="dot-3"></div>
                </div>

                <!-- Step 0：課堂氣氛 -->
                <div id="step-0" class="journal-step active">
                  <div class="ai-bubble">
                    <div class="ai-avatar">🤖</div>
                    <div class="ai-question">
                      今天上課的氣氛怎麼樣？選一個最貼近的感覺吧！
                    </div>
                  </div>
                  <div class="emoji-choices">
                    <button
                      class="emoji-btn"
                      onclick="selectMood(this, '活潑')"
                    >
                      😊<span style="font-size: 12px; color: #6b7280"
                        >活潑</span
                      >
                    </button>
                    <button
                      class="emoji-btn"
                      onclick="selectMood(this, '普通')"
                    >
                      😐<span style="font-size: 12px; color: #6b7280"
                        >普通</span
                      >
                    </button>
                    <button
                      class="emoji-btn"
                      onclick="selectMood(this, '低迷')"
                    >
                      😔<span style="font-size: 12px; color: #6b7280"
                        >低迷</span
                      >
                    </button>
                    <button
                      class="emoji-btn"
                      onclick="selectMood(this, '躁動')"
                    >
                      😤<span style="font-size: 12px; color: #6b7280"
                        >躁動</span
                      >
                    </button>
                  </div>
                  <textarea
                    id="mood-detail"
                    class="step-textarea"
                    placeholder="想補充什麼細節嗎？（選填）"
                  ></textarea>
                  <div class="step-nav">
                    <button
                      id="step0-next"
                      class="btn-step-next"
                      disabled
                      onclick="nextStep(1)"
                    >
                      下一步 →
                    </button>
                  </div>
                </div>

                <!-- Step 1：特別關注 -->
                <div id="step-1" class="journal-step">
                  <div class="ai-bubble">
                    <div class="ai-avatar">🤖</div>
                    <div class="ai-question">
                      有缺席的同學，需要特別關注嗎？可以幫他們加上標籤和備註。
                    </div>
                  </div>
                  <div id="concern-students-list"></div>
                  <button class="btn-add-student" onclick="addConcernStudent()">
                    ＋ 新增其他學生
                  </button>
                  <div class="step-nav">
                    <button class="btn-step-skip" onclick="skipConcern()">
                      略過
                    </button>
                    <button class="btn-step-next" onclick="nextStep(2)">
                      下一步 →
                    </button>
                  </div>
                </div>

                <!-- Step 2：教學反思 -->
                <div id="step-2" class="journal-step">
                  <div class="ai-bubble">
                    <div class="ai-avatar">🤖</div>
                    <div class="ai-question">
                      今天的教學有什麼感想？挑幾個標籤或寫幾句都行！
                    </div>
                  </div>
                  <div id="reflect-tags"></div>
                  <textarea
                    id="reflect-detail"
                    class="step-textarea"
                    placeholder="想補充的反思內容…（選填）"
                  ></textarea>
                  <div class="step-nav">
                    <button class="btn-step-skip" onclick="nextStep(3)">
                      略過
                    </button>
                    <button class="btn-step-next" onclick="nextStep(3)">
                      下一步 →
                    </button>
                  </div>
                </div>

                <!-- Step 3：明日計畫 -->
                <div id="step-3" class="journal-step">
                  <div class="ai-bubble">
                    <div class="ai-avatar">🤖</div>
                    <div class="ai-question">明天有什麼要提前準備的嗎？</div>
                  </div>
                  <div id="plan-tags"></div>
                  <textarea
                    id="plan-detail"
                    class="step-textarea"
                    placeholder="其他計畫補充…（選填）"
                  ></textarea>
                  <div class="step-nav">
                    <button class="btn-step-skip" onclick="composeJournal()">
                      略過
                    </button>
                    <button class="btn-step-next" onclick="composeJournal()">
                      完成 ✨
                    </button>
                  </div>
                </div>

                <!-- 完成預覽 -->
                <div id="step-preview" class="journal-step">
                  <div class="ai-bubble">
                    <div class="ai-avatar">🤖</div>
                    <div class="ai-question">
                      日誌幫你組好了！可以直接修改內容，確認後按儲存。
                    </div>
                  </div>
                  <div
                    class="journal-preview"
                    id="journal-composed"
                    contenteditable="true"
                  ></div>
                  <div class="step-nav" style="margin-top: 14px">
                    <button
                      class="btn-step-next"
                      onclick="saveComposedJournal()"
                      style="width: 100%"
                    >
                      確認儲存 📝
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <!-- 返回首頁 -->
            <button
              class="btn-secondary"
              onclick="returnHome()"
              style="padding: 14px; font-size: 15px"
            >
              返回首頁
            </button>
          </div>
        </div>
        <!-- end content-area -->
      </div>
      <!-- end phone-screen -->
    </div>
    <!-- end phone-shell -->

    <!-- ═══════════════════════════════════════════
       JavaScript：假資料 + 互動邏輯
  ════════════════════════════════════════════ -->
    <script>
      // ── 假資料：三個班級設定 ──
      const CLASSES = [
        { name: "光明國小 A班", time: "09:00 - 11:00", total: 12 },
        { name: "希望國小 B班", time: "14:00 - 16:00", total: 15 },
        { name: "陽光國小 C班", time: "09:30 - 11:30", total: 10 },
      ];

      // ── 假資料：學生名單（常見中文名） ──
      const STUDENTS = [
        // 光明國小 A班 - 12 人
        [
          "王小明",
          "陳美麗",
          "李大華",
          "張志豪",
          "林雅婷",
          "黃建國",
          "吳佳穎",
          "劉俊傑",
          "謝雨晴",
          "楊家豪",
          "周婉君",
          "鄭宇翔",
        ],
        // 希望國小 B班 - 15 人
        [
          "蔡政霖",
          "許淑娟",
          "高志遠",
          "洪雅雯",
          "廖建宏",
          "彭怡君",
          "鄧國偉",
          "葉曉青",
          "曾偉誠",
          "賴雅惠",
          "盧博文",
          "潘欣儀",
          "江俊德",
          "邱美珍",
          "蘇哲維",
        ],
        // 陽光國小 C班 - 10 人
        [
          "施雅芳",
          "韓宗翰",
          "龔欣妤",
          "傅建志",
          "翁佩珊",
          "詹宇成",
          "孫雅玲",
          "馬志剛",
          "戴美惠",
          "朱明哲",
        ],
      ];

      // 缺席原因選項
      const ABSENCE_REASONS = ["事假", "病假", "曠課"];

      // ══════════════════════════
      // 狀態管理（可變，記錄各班狀態）
      // ══════════════════════════

      let currentClassIndex = -1; // 目前正在點名的班級
      const completedClasses = [false, false, false]; // 各班是否已完成
      let attendanceData = {}; // 目前班級的出席資料

      // ══════════════════════════
      // 初始化：設定時間、日期、問候語
      // ══════════════════════════
      function init() {
        // 即時時鐘
        updateClock();
        setInterval(updateClock, 30000);

        // 根據時間決定問候語
        const hour = new Date().getHours();
        let greetText = "早安！☀️ 今天也辛苦了";
        if (hour >= 12 && hour < 14) greetText = "午安！🌤️ 吃飯了嗎";
        else if (hour >= 14 && hour < 18) greetText = "下午好！☀️ 加油加油";
        else if (hour >= 18) greetText = "晚安！🌙 感謝你今天的付出";
        document.getElementById("greeting").textContent = greetText;

        // 今日日期（中文格式）
        const now = new Date();
        const dateStr = now.toLocaleDateString("zh-TW", {
          year: "numeric",
          month: "long",
          day: "numeric",
          weekday: "long",
        });
        document.getElementById("todayDate").textContent = dateStr;
      }

      // 更新狀態列時鐘
      function updateClock() {
        const now = new Date();
        const h = String(now.getHours()).padStart(2, "0");
        const m = String(now.getMinutes()).padStart(2, "0");
        document.getElementById("statusTime").textContent = `${h}:${m}`;
      }

      // ══════════════════════════
      // 工具：切換顯示畫面
      // ══════════════════════════
      function showScreen(id) {
        document
          .querySelectorAll(".screen")
          .forEach((el) => el.classList.remove("active"));
        document.getElementById(id).classList.add("active");
        // 滾回頂部
        document.querySelector(".content-area").scrollTop = 0;
      }

      // ══════════════════════════
      // 狀態 1 → 狀態 2：開始點名
      // ══════════════════════════
      function startRoll(classIndex) {
        if (completedClasses[classIndex]) return; // 已完成就阻擋

        currentClassIndex = classIndex;
        const cls = CLASSES[classIndex];
        const students = STUDENTS[classIndex];

        // 初始化出席資料（預設全部出席）
        attendanceData = {};
        students.forEach((_, i) => {
          attendanceData[i] = { present: true, reason: "事假" };
        });

        // 填入 Header 資訊
        document.getElementById("roll-class-name").textContent = cls.name;
        refreshCounter();

        // 渲染學生列表
        renderStudentList(students);

        showScreen("screen-roll");
      }

      // ── 渲染學生卡片列表 ──
      function renderStudentList(students) {
        const container = document.getElementById("student-list");
        container.innerHTML = "";
        students.forEach((name, i) => {
          container.appendChild(buildStudentCard(i, name));
        });
      }

      // ── 建立單一學生卡片 DOM 元素 ──
      function buildStudentCard(index, name) {
        const div = document.createElement("div");
        div.id = `sc-${index}`;
        div.className = `student-card ${attendanceData[index].present ? "student-present" : "student-absent"}`;
        div.innerHTML = studentCardHTML(index, name);
        div.onclick = () => toggleStudent(index, name);
        return div;
      }

      // ── 學生卡片內容 HTML ──
      function studentCardHTML(index, name) {
        const present = attendanceData[index].present;

        if (present) {
          // 出席狀態
          return `
          <div style="display:flex;align-items:center;gap:11px;">
            <div style="width:38px;height:38px;background:#D1FAE5;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;">✅</div>
            <div>
              <p style="font-size:15px;font-weight:700;color:#111827;margin-bottom:1px;">${name}</p>
              <p style="font-size:11px;color:#10B981;font-weight:600;">出席中</p>
            </div>
          </div>
          <span style="font-size:11px;color:#D1FAE5;font-weight:500;letter-spacing:0.2px;">點擊標記缺席</span>
        `;
        } else {
          // 缺席狀態：含下拉原因選單
          const options = ABSENCE_REASONS.map(
            (r) =>
              `<option value="${r}"${attendanceData[index].reason === r ? " selected" : ""}>${r}</option>`,
          ).join("");
          return `
          <div style="display:flex;align-items:center;gap:11px;">
            <div style="width:38px;height:38px;background:#FCE7F3;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;">❌</div>
            <div>
              <p style="font-size:15px;font-weight:700;color:#111827;margin-bottom:1px;">${name}</p>
              <p style="font-size:11px;color:#EC4899;font-weight:600;">缺席</p>
            </div>
          </div>
          <select class="absence-select"
                  onclick="event.stopPropagation()"
                  onchange="updateReason(${index}, this.value)">
            ${options}
          </select>
        `;
        }
      }

      // ── 切換出席 / 缺席 ──
      function toggleStudent(index, name) {
        // 更新資料（不可變模式：建立新物件）
        attendanceData = {
          ...attendanceData,
          [index]: {
            ...attendanceData[index],
            present: !attendanceData[index].present,
          },
        };

        // 更新卡片外觀
        const card = document.getElementById(`sc-${index}`);
        card.className = `student-card ${attendanceData[index].present ? "student-present" : "student-absent"}`;
        card.innerHTML = studentCardHTML(index, name);

        // 重新綁定 onclick（innerHTML 清空後需要重設）
        card.onclick = () => toggleStudent(index, name);

        // 更新計數器
        refreshCounter();
      }

      // ── 更新缺席原因 ──
      function updateReason(index, reason) {
        attendanceData = {
          ...attendanceData,
          [index]: { ...attendanceData[index], reason },
        };
      }

      // ── 即時更新出席計數器 ──
      function refreshCounter() {
        const students = STUDENTS[currentClassIndex];
        const total = students.length;
        const presentCount = Object.values(attendanceData).filter(
          (d) => d.present,
        ).length;
        const pct = Math.round((presentCount / total) * 100);

        document.getElementById("present-count").textContent = presentCount;
        document.getElementById("total-count").textContent = `/ ${total} 人`;
        document.getElementById("percent-display").textContent = `${pct}%`;
        document.getElementById("roll-progress-bar").style.width = `${pct}%`;
      }

      // ══════════════════════════
      // 狀態 2 → 狀態 3：完成點名
      // ══════════════════════════
      function finishRoll() {
        const cls = CLASSES[currentClassIndex];
        const students = STUDENTS[currentClassIndex];
        const total = students.length;
        const presentCount = Object.values(attendanceData).filter(
          (d) => d.present,
        ).length;
        const absentCount = total - presentCount;

        // 填入完成頁資訊
        document.getElementById("done-class-name").textContent =
          `${cls.name} · ${cls.time}`;
        document.getElementById("done-present").textContent = presentCount;
        document.getElementById("done-absent").textContent = absentCount;
        document.getElementById("done-total").textContent = total;

        // 渲染缺席名單
        renderAbsentList(students);

        // 重設日誌區塊（每次進入都是乾淨的）
        document.getElementById("journal-trigger").style.display = "block";
        document.getElementById("journal-guide").style.display = "none";

        showScreen("screen-done");
      }

      // ── 渲染缺席名單 ──
      function renderAbsentList(students) {
        const section = document.getElementById("absent-list-section");
        const content = document.getElementById("absent-list-content");
        content.innerHTML = "";

        const absentList = students
          .map((name, i) => ({ name, ...attendanceData[i] }))
          .filter((s) => !s.present);

        if (absentList.length === 0) {
          section.style.display = "none";
          return;
        }

        section.style.display = "block";

        absentList.forEach((s) => {
          const item = document.createElement("div");
          item.style.cssText =
            "display:flex;align-items:center;justify-content:space-between;padding:10px 13px;background:#FFF4FB;border-radius:10px;border:1.5px solid #F9A8D4;";
          item.innerHTML = `
          <div style="display:flex;align-items:center;gap:9px;">
            <span style="font-size:15px;">❌</span>
            <span style="font-size:14px;font-weight:700;color:#111827;">${s.name}</span>
          </div>
          <span style="font-size:11px;font-weight:700;color:#EC4899;background:white;padding:3px 10px;border-radius:20px;border:1.5px solid #F9A8D4;">${s.reason}</span>
        `;
          content.appendChild(item);
        });
      }

      // ══════════════════════════
      // AI 引導日誌系統
      // ══════════════════════════

      // 狀態變數
      let journalStep = 0;
      let journalData = {
        mood: "",
        moodEmoji: "",
        moodDetail: "",
        concerns: [],
        reflectTags: [],
        reflectDetail: "",
        planTags: [],
        planDetail: "",
      };

      // 標籤選項
      const REFLECT_TAGS = [
        "教學進度順利",
        "活動效果好",
        "需要調整教材",
        "時間不夠用",
        "學生反應冷淡",
      ];
      const PLAN_TAGS = [
        "準備教材",
        "跟進個案",
        "聯繫家長",
        "調整座位",
        "無特別事項",
      ];
      const CONCERN_TAGS = ["情緒波動", "人際衝突", "學習困難", "家庭狀況"];

      // emoji 對照表（用於日誌組合時顯示 emoji）
      const MOOD_EMOJI_MAP = {
        活潑: "😊",
        普通: "😐",
        低迷: "😔",
        躁動: "😤",
      };

      // ── 啟動引導流程 ──
      function startJournalGuide() {
        // 重設所有狀態
        journalStep = 0;
        journalData = {
          mood: "",
          moodEmoji: "",
          moodDetail: "",
          concerns: [],
          reflectTags: [],
          reflectDetail: "",
          planTags: [],
          planDetail: "",
        };

        // 切換顯示
        document.getElementById("journal-trigger").style.display = "none";
        document.getElementById("journal-guide").style.display = "block";

        // 重設 emoji 按鈕狀態
        document
          .querySelectorAll(".emoji-btn")
          .forEach((b) => b.classList.remove("selected"));
        document.getElementById("step0-next").disabled = true;
        document.getElementById("mood-detail").value = "";

        // 渲染缺席名單成關注卡片
        renderConcernStudents();

        // 渲染標籤選項
        renderTagPills("reflect-tags", REFLECT_TAGS, "reflectTags");
        renderTagPills("plan-tags", PLAN_TAGS, "planTags");

        // 清空文字框
        document.getElementById("reflect-detail").value = "";
        document.getElementById("plan-detail").value = "";

        // 顯示第一步
        showJournalStep(0);
      }

      // ── 切換步驟顯示 + 更新進度圓點 ──
      function showJournalStep(idx) {
        journalStep = idx;

        // 隱藏所有步驟
        document
          .querySelectorAll(".journal-step")
          .forEach((s) => s.classList.remove("active"));

        // 顯示目標步驟（idx=4 時顯示預覽）
        const targetId = idx === 4 ? "step-preview" : `step-${idx}`;
        const target = document.getElementById(targetId);
        if (target) target.classList.add("active");

        // 更新進度圓點
        for (let i = 0; i < 4; i++) {
          const dot = document.getElementById(`dot-${i}`);
          dot.classList.remove("active", "done");
          if (i < idx) {
            dot.classList.add("done");
          } else if (i === idx && idx < 4) {
            dot.classList.add("active");
          } else if (idx === 4) {
            // 全部完成
            dot.classList.add("done");
          }
        }
      }

      // ── 選擇課堂氣氛 emoji ──
      function selectMood(btn, mood) {
        // 取消其他按鈕選取
        document
          .querySelectorAll(".emoji-btn")
          .forEach((b) => b.classList.remove("selected"));
        // 選取當前按鈕
        btn.classList.add("selected");

        journalData = {
          ...journalData,
          mood,
          moodEmoji: MOOD_EMOJI_MAP[mood] || "",
        };

        // 啟用下一步按鈕
        document.getElementById("step0-next").disabled = false;
      }

      // ── 前進到下一步（收集當前步驟資料） ──
      function nextStep(toIdx) {
        // 收集當前步驟的資料
        if (journalStep === 0) {
          journalData = {
            ...journalData,
            moodDetail: document.getElementById("mood-detail").value.trim(),
          };
        } else if (journalStep === 1) {
          // concerns 已經在 toggleConcernTag / updateConcernNote 中即時更新
        } else if (journalStep === 2) {
          journalData = {
            ...journalData,
            reflectDetail: document
              .getElementById("reflect-detail")
              .value.trim(),
          };
        } else if (journalStep === 3) {
          journalData = {
            ...journalData,
            planDetail: document.getElementById("plan-detail").value.trim(),
          };
        }

        showJournalStep(toIdx);
      }

      // ── 渲染缺席學生關注卡片 ──
      function renderConcernStudents() {
        const container = document.getElementById("concern-students-list");
        container.innerHTML = "";

        const students = STUDENTS[currentClassIndex];
        // 從缺席名單初始化 concerns
        const absentStudents = students
          .map((name, i) => ({ name, index: i, ...attendanceData[i] }))
          .filter((s) => !s.present);

        journalData = {
          ...journalData,
          concerns: absentStudents.map((s) => ({
            name: s.name,
            reason: s.reason || "缺席",
            tags: [],
            note: "",
            isManual: false,
          })),
        };

        // 渲染每個關注學生卡片
        journalData.concerns.forEach((concern, idx) => {
          container.appendChild(buildConcernCard(idx, concern));
        });
      }

      // ── 建立關注學生卡片 DOM ──
      function buildConcernCard(idx, concern) {
        const div = document.createElement("div");
        div.className = "concern-student";
        div.id = `concern-${idx}`;
        // 手動新增的用藍色邊框
        if (concern.isManual) {
          div.style.borderColor = "#93c5fd";
          div.style.background = "#eff6ff";
        }

        const nameLabel = concern.isManual
          ? `<input type="text" value="${concern.name}" placeholder="輸入學生姓名"
              style="border:1.5px solid #c7d2fe;border-radius:8px;padding:4px 8px;font-size:14px;font-weight:700;width:120px;font-family:'Noto Sans TC',sans-serif;"
              onchange="journalData.concerns[${idx}].name=this.value">`
          : `<span>${concern.name}</span>`;

        // 標籤 pills
        const tagHTML = CONCERN_TAGS.map((tag) => {
          const isSelected = concern.tags.includes(tag);
          return `<span class="tag-pill${isSelected ? " selected" : ""}"
                   onclick="toggleConcernTag(this, ${idx}, '${tag}')">${tag}</span>`;
        }).join("");

        div.innerHTML = `
          <div class="name">${nameLabel}（${concern.reason}）</div>
          <div class="tags">${tagHTML}</div>
          <input type="text" value="${concern.note}" placeholder="備註（選填）"
            style="width:100%;border:1.5px solid #e5e7eb;border-radius:8px;padding:6px 10px;font-size:12px;font-family:'Noto Sans TC',sans-serif;"
            oninput="updateConcernNote(${idx}, this.value)">
        `;
        return div;
      }

      // ── 切換關注標籤 ──
      function toggleConcernTag(el, studentIdx, tag) {
        const concern = journalData.concerns[studentIdx];
        const currentTags = concern.tags || [];
        const hasTag = currentTags.includes(tag);

        // 不可變更新
        const newTags = hasTag
          ? currentTags.filter((t) => t !== tag)
          : [...currentTags, tag];

        journalData = {
          ...journalData,
          concerns: journalData.concerns.map((c, i) =>
            i === studentIdx ? { ...c, tags: newTags } : c,
          ),
        };

        // 切換 UI
        el.classList.toggle("selected");
      }

      // ── 更新關注備註 ──
      function updateConcernNote(studentIdx, val) {
        journalData = {
          ...journalData,
          concerns: journalData.concerns.map((c, i) =>
            i === studentIdx ? { ...c, note: val } : c,
          ),
        };
      }

      // ── 略過關注學生，直接到下一步 ──
      function skipConcern() {
        journalData = { ...journalData, concerns: [] };
        showJournalStep(2);
      }

      // ── 新增空白關注學生卡片 ──
      function addConcernStudent() {
        const newConcern = {
          name: "",
          reason: "其他",
          tags: [],
          note: "",
          isManual: true,
        };

        journalData = {
          ...journalData,
          concerns: [...journalData.concerns, newConcern],
        };

        const container = document.getElementById("concern-students-list");
        const idx = journalData.concerns.length - 1;
        container.appendChild(buildConcernCard(idx, newConcern));
      }

      // ── 通用 pill 標籤渲染 ──
      function renderTagPills(containerId, tags, dataKey) {
        const container = document.getElementById(containerId);
        container.innerHTML = "";
        tags.forEach((tag) => {
          const pill = document.createElement("span");
          pill.className = "tag-pill";
          pill.textContent = tag;
          pill.onclick = () => {
            const current = journalData[dataKey] || [];
            const has = current.includes(tag);
            const updated = has
              ? current.filter((t) => t !== tag)
              : [...current, tag];

            journalData = { ...journalData, [dataKey]: updated };
            pill.classList.toggle("selected");
          };
          container.appendChild(pill);
        });
      }

      // ── 組合結構化日誌 ──
      function composeJournal() {
        // 先收集最後一步的資料
        if (journalStep === 3) {
          journalData = {
            ...journalData,
            planDetail: document.getElementById("plan-detail").value.trim(),
          };
        }

        const cls = CLASSES[currentClassIndex];
        const students = STUDENTS[currentClassIndex];
        const total = students.length;
        const presentCount = Object.values(attendanceData).filter(
          (d) => d.present,
        ).length;

        // 取得今天日期
        const now = new Date();
        const dateStr = `${now.getFullYear()}/${now.getMonth() + 1}/${now.getDate()}`;

        // 組合日誌
        let text = `【${cls.name}】班級日誌\n`;
        text += `日期：${dateStr}\n`;
        text += `出席：${presentCount}/${total} 人\n\n`;

        // 課堂氣氛
        text += `📍 課堂氣氛：${journalData.moodEmoji} ${journalData.mood}\n`;
        if (journalData.moodDetail) {
          text += `   ${journalData.moodDetail}\n`;
        }

        // 特別關注
        const validConcerns = journalData.concerns.filter((c) => c.name);
        if (validConcerns.length > 0) {
          text += `\n⚠️ 需特別關注：\n`;
          validConcerns.forEach((c) => {
            const tagStr = c.tags.length > 0 ? `（${c.tags.join("、")}）` : "";
            const noteStr = c.note ? `— ${c.note}` : "";
            text += `  · ${c.name}：${c.reason}${tagStr}${noteStr}\n`;
          });
        }

        // 教學反思
        if (journalData.reflectTags.length > 0 || journalData.reflectDetail) {
          text += `\n📝 教學反思：\n`;
          if (journalData.reflectTags.length > 0) {
            text += `  ${journalData.reflectTags.join("、")}\n`;
          }
          if (journalData.reflectDetail) {
            text += `  ${journalData.reflectDetail}\n`;
          }
        }

        // 明日計畫
        if (journalData.planTags.length > 0 || journalData.planDetail) {
          text += `\n📋 明日計畫：\n`;
          if (journalData.planTags.length > 0) {
            text += `  ${journalData.planTags.join("、")}\n`;
          }
          if (journalData.planDetail) {
            text += `  ${journalData.planDetail}\n`;
          }
        }

        // 顯示在預覽區
        document.getElementById("journal-composed").textContent = text;

        // 切到預覽步驟
        showJournalStep(4);
      }

      // ── 確認儲存日誌（Demo 版） ──
      function saveComposedJournal() {
        const btn = document.querySelector("#step-preview .btn-step-next");
        btn.textContent = "已儲存 ✅";
        btn.disabled = true;
        btn.style.background = "#10b981";
        btn.style.boxShadow = "0 4px 16px rgba(16,185,129,0.35)";
      }

      // ══════════════════════════
      // 狀態 3 → 狀態 1：返回首頁（完成）
      // ══════════════════════════
      function returnHome() {
        // 標記已完成
        completedClasses[currentClassIndex] = true;

        // 更新首頁班級卡片外觀
        markClassCompleted(currentClassIndex);

        showScreen("screen-home");
      }

      // ── 更新班級卡片為「已完成」樣式 ──
      function markClassCompleted(idx) {
        const card = document.getElementById(`card-${idx}`);
        const badge = document.getElementById(`status-badge-${idx}`);
        const btn = document.getElementById(`action-btn-${idx}`);

        // 卡片整體淡化
        card.classList.add("completed");

        // 標籤改為綠色
        badge.style.background = "#D1FAE5";
        badge.style.color = "#059669";
        badge.textContent = "已完成 ✅";

        // 按鈕改為灰色禁用
        btn.style.background = "#F3F4F6";
        btn.style.boxShadow = "none";
        btn.style.color = "#9CA3AF";
        btn.textContent = "點名完成 ✅";
        btn.disabled = true;
      }

      // ── 從點名頁返回首頁（不標記完成） ──
      function goHome() {
        showScreen("screen-home");
      }

      // ══════════════════════════
      // 啟動
      // ══════════════════════════
      init();
    </script>
  </body>
</html>
