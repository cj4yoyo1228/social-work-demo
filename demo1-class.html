<!doctype html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ç­ç´šç®¡ç†ä¸­å¿ƒ â€” ç¤¾å·¥ç®¡ç†ç³»çµ±</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="shared.css" />
    <style>
      body {
        background: #f0f2f5;
        display: flex;
        justify-content: center;
        padding: 24px 16px;
        min-height: 100vh;
      }

      /* æ‰‹æ©Ÿå…§å®¹å€åŸŸ */
      .phone-inner {
        padding: 0 0 24px;
      }

      /* é ‚éƒ¨æ¼¸å±¤ Header */
      .app-header {
        background: linear-gradient(135deg, #6366f1 0%, #818cf8 100%);
        color: white;
        padding: 20px 20px 24px;
        position: relative;
      }

      .app-header .back-link {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        color: rgba(255, 255, 255, 0.8);
        text-decoration: none;
        font-size: 13px;
        margin-bottom: 12px;
      }

      .app-header .back-link:hover {
        color: white;
      }

      .greeting {
        font-size: 20px;
        font-weight: 700;
        margin-bottom: 4px;
      }

      .sub-info {
        font-size: 13px;
        opacity: 0.85;
      }

      /* ç­ç´šä»»å‹™å¡ç‰‡ */
      .task-card {
        background: white;
        border-radius: 12px;
        padding: 16px;
        margin: 0 16px 12px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        transition:
          transform 0.2s ease,
          box-shadow 0.2s ease;
      }

      .task-card:first-child {
        margin-top: -12px;
      }

      .task-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      .task-card-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 8px;
      }

      .class-name {
        font-size: 16px;
        font-weight: 700;
        color: #1f2937;
      }

      .class-time {
        font-size: 12px;
        color: #9ca3af;
      }

      .class-meta {
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: 13px;
        color: #6b7280;
        margin-bottom: 12px;
      }

      .start-btn {
        width: 100%;
        padding: 10px;
        background: #6366f1;
        color: white;
        border: none;
        border-radius: 10px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.2s ease;
        font-family: "Noto Sans TC", sans-serif;
      }

      .start-btn:hover {
        background: #4f46e5;
      }

      .start-btn.done {
        background: #d1fae5;
        color: #059669;
        cursor: default;
      }

      /* é»åç•«é¢ */
      .attendance-header {
        background: linear-gradient(135deg, #6366f1 0%, #818cf8 100%);
        color: white;
        padding: 16px 20px;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .attendance-header .back-arrow {
        cursor: pointer;
        font-size: 18px;
        padding: 4px;
      }

      .attendance-title {
        font-size: 16px;
        font-weight: 700;
      }

      .attendance-count {
        font-size: 13px;
        background: rgba(255, 255, 255, 0.2);
        padding: 4px 12px;
        border-radius: 20px;
      }

      /* å®Œæˆç•«é¢ */
      .complete-screen {
        text-align: center;
        padding: 32px 20px;
      }

      .complete-icon {
        width: 80px;
        height: 80px;
        background: #d1fae5;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 40px;
        margin: 0 auto 16px;
      }

      .complete-title {
        font-size: 20px;
        font-weight: 700;
        color: #1f2937;
        margin-bottom: 8px;
      }

      .complete-subtitle {
        font-size: 14px;
        color: #6b7280;
        margin-bottom: 24px;
      }

      .summary-card {
        background: #f9fafb;
        border-radius: 12px;
        padding: 16px;
        margin: 0 4px 16px;
        text-align: left;
      }

      .summary-row {
        display: flex;
        justify-content: space-between;
        padding: 6px 0;
        font-size: 14px;
      }

      .summary-label {
        color: #6b7280;
      }

      .summary-value {
        font-weight: 600;
        color: #1f2937;
      }

      .absent-list {
        text-align: left;
        margin: 0 4px 20px;
      }

      .absent-list-title {
        font-size: 14px;
        font-weight: 600;
        color: #374151;
        margin-bottom: 8px;
      }

      .absent-student {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        background: #fef2f2;
        border-radius: 8px;
        margin-bottom: 6px;
        font-size: 13px;
      }

      .absent-student .name {
        font-weight: 600;
        color: #1f2937;
      }

      .absent-student .reason {
        color: #9ca3af;
        font-size: 12px;
      }

      /* ç¼ºå¸­é¸é …ä¸‹æ‹‰ */
      .absence-options {
        display: none;
        padding: 8px 16px 12px 56px;
        background: #fef2f2;
        border-bottom: 1px solid #fecaca;
        animation: fadeIn 0.2s ease;
      }

      .absence-options.show {
        display: block;
      }

      .absence-options select {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        font-size: 13px;
        font-family: "Noto Sans TC", sans-serif;
        color: #374151;
        background: white;
        margin-bottom: 6px;
        outline: none;
      }

      .absence-options select:focus {
        border-color: #6366f1;
      }

      .absence-options input {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        font-size: 13px;
        font-family: "Noto Sans TC", sans-serif;
        outline: none;
        box-sizing: border-box;
      }

      .absence-options input:focus {
        border-color: #6366f1;
      }

      /* åº•éƒ¨å›ºå®šæŒ‰éˆ• */
      .bottom-action {
        padding: 16px 20px;
        background: white;
        border-top: 1px solid #f3f4f6;
        position: sticky;
        bottom: 0;
      }
    </style>
  </head>
  <body>
    <div class="phone-frame">
      <!-- ===== ç‹€æ…‹ 1ï¼šä»Šæ—¥ä»»å‹™åˆ—è¡¨ ===== -->
      <div id="view-tasks" class="view active">
        <div class="app-header">
          <a href="index.html" class="back-link">â† å›åˆ°é¦–é </a>
          <div class="greeting" id="greeting-text">æ—©å®‰ï¼Œå°æ˜ï¼</div>
          <div class="sub-info" id="tasks-info">ä»Šå¤©æœ‰ 2 å€‹ç­ç´šç­‰ä½ æœå‹™ ğŸ“±</div>
        </div>
        <div class="phone-inner">
          <div id="task-list" style="padding-top: 24px"></div>
        </div>
      </div>

      <!-- ===== ç‹€æ…‹ 2ï¼šé»åç•«é¢ ===== -->
      <div id="view-attendance" class="view">
        <div class="attendance-header">
          <span class="back-arrow" onclick="backToTasks()">â†</span>
          <span class="attendance-title" id="att-class-name">å…‰æ˜åœ‹å° Aç­</span>
          <span class="attendance-count" id="att-count">12/12 å‡ºå¸­</span>
        </div>
        <div id="student-list"></div>
        <div class="bottom-action">
          <button
            class="btn-primary"
            style="width: 100%"
            id="finish-btn"
            onclick="finishAttendance()"
          >
            âœ… å®Œæˆé»å
          </button>
        </div>
      </div>

      <!-- ===== ç‹€æ…‹ 3ï¼šé»åå®Œæˆ ===== -->
      <div id="view-complete" class="view">
        <div class="app-header" style="padding-bottom: 20px">
          <a href="index.html" class="back-link">â† å›åˆ°é¦–é </a>
        </div>
        <div class="complete-screen">
          <div class="complete-icon checkmark-animation">âœ“</div>
          <div class="complete-title">é»åå®Œæˆï¼</div>
          <div class="complete-subtitle" id="complete-class-name">
            å…‰æ˜åœ‹å° Aç­
          </div>

          <div class="summary-card">
            <div class="summary-row">
              <span class="summary-label">ç¸½äººæ•¸</span>
              <span class="summary-value" id="sum-total">12</span>
            </div>
            <div class="summary-row">
              <span class="summary-label">å‡ºå¸­</span>
              <span
                class="summary-value"
                style="color: #059669"
                id="sum-present"
                >11</span
              >
            </div>
            <div class="summary-row">
              <span class="summary-label">ç¼ºå¸­/è«‹å‡</span>
              <span class="summary-value" style="color: #dc2626" id="sum-absent"
                >1</span
              >
            </div>
          </div>

          <div class="absent-list" id="absent-detail"></div>

          <button
            class="btn-primary"
            style="width: 100%; margin-bottom: 12px"
            onclick="showToast('æ­¤ç‚º Demo å±•ç¤ºï¼Œæ—¥èªŒåŠŸèƒ½å³å°‡æ¨å‡º')"
          >
            ğŸ“ æ’°å¯«ä»Šæ—¥æ—¥èªŒ
          </button>
          <button
            class="btn-secondary"
            style="width: 100%"
            onclick="backToTasksFromComplete()"
          >
            è¿”å›ä»»å‹™åˆ—è¡¨
          </button>
        </div>
      </div>
    </div>

    <script src="shared.js"></script>
    <script>
      /* === ç‹€æ…‹ç®¡ç† === */

      /* ç›®å‰ç™»å…¥çš„ç¤¾å·¥ï¼ˆæ¨¡æ“¬ sw1 å°æ˜ï¼‰ */
      const CURRENT_WORKER = "sw1";

      /* å„ç­ç´šé»åç‹€æ…‹ï¼Œkey = classId */
      const attendanceState = {};

      /* ç›®å‰æ­£åœ¨é»åçš„ç­ç´š ID */
      let currentClassId = null;

      /* === ç•«é¢åˆ‡æ› === */
      function showView(viewName) {
        document.querySelectorAll(".view").forEach(function (v) {
          v.classList.remove("active");
        });
        var target = document.getElementById("view-" + viewName);
        if (target) {
          target.classList.add("active");
        }
      }

      /* === åˆå§‹åŒ–ï¼šæ¸²æŸ“ä»»å‹™åˆ—è¡¨ === */
      function init() {
        /* å‹•æ…‹å•å€™èª */
        var hour = new Date().getHours();
        var greetText = "æ—©å®‰";
        if (hour >= 12 && hour < 18) greetText = "åˆå®‰";
        else if (hour >= 18) greetText = "æ™šå®‰";
        document.getElementById("greeting-text").textContent =
          greetText + "ï¼Œå°æ˜ï¼";

        /* å–å¾—æ­¤ç¤¾å·¥çš„ç­ç´š */
        var myClasses = getWorkerClasses(CURRENT_WORKER);
        document.getElementById("tasks-info").textContent =
          "ä»Šå¤©æœ‰ " + myClasses.length + " å€‹ç­ç´šç­‰ä½ æœå‹™ ğŸ“±";

        /* æ¸²æŸ“ç­ç´šå¡ç‰‡ */
        var container = document.getElementById("task-list");
        var html = "";
        for (var i = 0; i < myClasses.length; i++) {
          var cls = myClasses[i];
          var isDone = attendanceState[cls.id] && attendanceState[cls.id].done;
          html +=
            '<div class="task-card fade-in" style="animation-delay: ' +
            i * 0.08 +
            's">';
          html += '<div class="task-card-header">';
          html += '<span class="class-name">' + cls.name + "</span>";
          html += '<span class="class-time">' + cls.time + "</span>";
          html += "</div>";
          html += '<div class="class-meta">';
          html += "<span>ğŸ« " + cls.school + "</span>";
          html += "<span>ğŸ‘¥ " + cls.studentCount + " äºº</span>";
          html += "</div>";
          if (isDone) {
            html += '<button class="start-btn done">âœ… å·²å®Œæˆé»å</button>';
          } else {
            html +=
              '<button class="start-btn" onclick="startAttendance(\'' +
              cls.id +
              "')\">é–‹å§‹é»å</button>";
          }
          html += "</div>";
        }
        container.innerHTML = html;
      }

      /* === é–‹å§‹é»å === */
      function startAttendance(classId) {
        currentClassId = classId;

        /* æ‰¾åˆ°ç­ç´šè³‡è¨Š */
        var cls = null;
        for (var i = 0; i < CLASSES.length; i++) {
          if (CLASSES[i].id === classId) {
            cls = CLASSES[i];
            break;
          }
        }
        if (!cls) return;

        /* åˆå§‹åŒ–è©²ç­çš„é»åç‹€æ…‹ï¼ˆé è¨­å…¨å‹¤ï¼‰ */
        var students = STUDENTS[classId] || [];
        if (!attendanceState[classId]) {
          attendanceState[classId] = {
            done: false,
            students: {},
          };
          for (var i = 0; i < students.length; i++) {
            attendanceState[classId].students[students[i].id] = {
              present: true,
              reason: "",
              note: "",
            };
          }
        }

        document.getElementById("att-class-name").textContent = cls.name;
        renderStudentList(classId);
        updateAttendanceCount(classId);
        showView("attendance");
      }

      /* === æ¸²æŸ“å­¸ç”Ÿé»ååˆ—è¡¨ === */
      function renderStudentList(classId) {
        var students = STUDENTS[classId] || [];
        var state = attendanceState[classId];
        var container = document.getElementById("student-list");
        var html = "";

        for (var i = 0; i < students.length; i++) {
          var s = students[i];
          var st = state.students[s.id];
          var isPresent = st.present;
          var rowClass = isPresent ? "" : " absent";

          html +=
            '<div class="student-row' +
            rowClass +
            '" onclick="toggleStudent(\'' +
            classId +
            "', '" +
            s.id +
            "')\">";
          html += '<div class="status-icon">';
          html += isPresent ? "âœ…" : "âŒ";
          html += "</div>";
          html += '<div class="student-name">' + s.name + "</div>";

          /* å­¸ç”Ÿæ¨™ç±¤ */
          if (s.tags && s.tags.length > 0) {
            for (var t = 0; t < s.tags.length; t++) {
              var tagClass = "tag-small";
              if (s.tags[t] === "æƒ…ç·’èµ·ä¼å¤§" || s.tags[t] === "å®¶åº­ç‹€æ³ç‰¹æ®Š") {
                tagClass += " warning";
              }
              html +=
                '<span class="' + tagClass + '">' + s.tags[t] + "</span> ";
            }
          }
          html += "</div>";

          /* ç¼ºå¸­è©³æƒ…å±•é–‹å€ */
          if (!isPresent) {
            html +=
              '<div class="absence-options show" id="absence-' + s.id + '">';
            html +=
              "<select onchange=\"setReason('" +
              classId +
              "', '" +
              s.id +
              "', this.value)\">";
            html += '<option value="">é¸æ“‡åŸå› ...</option>';
            html +=
              '<option value="äº‹å‡"' +
              (st.reason === "äº‹å‡" ? " selected" : "") +
              ">äº‹å‡</option>";
            html +=
              '<option value="ç—…å‡"' +
              (st.reason === "ç—…å‡" ? " selected" : "") +
              ">ç—…å‡</option>";
            html +=
              '<option value="ç„¡æ•…ç¼ºå¸­"' +
              (st.reason === "ç„¡æ•…ç¼ºå¸­" ? " selected" : "") +
              ">ç„¡æ•…ç¼ºå¸­</option>";
            html +=
              '<option value="å…¶ä»–"' +
              (st.reason === "å…¶ä»–" ? " selected" : "") +
              ">å…¶ä»–</option>";
            html += "</select>";
            html +=
              '<input type="text" placeholder="å‚™è¨»ï¼ˆé¸å¡«ï¼‰" value="' +
              (st.note || "") +
              '" onchange="setNote(\'' +
              classId +
              "', '" +
              s.id +
              '\', this.value)" onclick="event.stopPropagation()" />';
            html += "</div>";
          }
        }

        container.innerHTML = html;
      }

      /* === åˆ‡æ›å­¸ç”Ÿå‡ºå¸­ç‹€æ…‹ === */
      function toggleStudent(classId, studentId) {
        var state = attendanceState[classId];
        var st = state.students[studentId];
        st.present = !st.present;
        if (st.present) {
          st.reason = "";
          st.note = "";
        }
        renderStudentList(classId);
        updateAttendanceCount(classId);
      }

      /* === è¨­å®šç¼ºå¸­åŸå›  === */
      function setReason(classId, studentId, value) {
        attendanceState[classId].students[studentId].reason = value;
        event.stopPropagation();
      }

      /* === è¨­å®šç¼ºå¸­å‚™è¨» === */
      function setNote(classId, studentId, value) {
        attendanceState[classId].students[studentId].note = value;
      }

      /* === æ›´æ–°å‡ºå¸­äººæ•¸é¡¯ç¤º === */
      function updateAttendanceCount(classId) {
        var state = attendanceState[classId];
        var total = 0;
        var present = 0;
        var keys = Object.keys(state.students);
        for (var i = 0; i < keys.length; i++) {
          total++;
          if (state.students[keys[i]].present) present++;
        }
        document.getElementById("att-count").textContent =
          present + "/" + total + " å‡ºå¸­";
      }

      /* === å®Œæˆé»å === */
      function finishAttendance() {
        var state = attendanceState[currentClassId];
        var keys = Object.keys(state.students);
        var absentStudents = [];

        /* æª¢æŸ¥æ˜¯å¦æœ‰ç¼ºå¸­ä½†æ²’é¸åŸå› çš„ */
        for (var i = 0; i < keys.length; i++) {
          var st = state.students[keys[i]];
          if (!st.present) {
            if (!st.reason) {
              showToast("è«‹ç‚ºç¼ºå¸­å­¸ç”Ÿé¸æ“‡åŸå› ");
              return;
            }
            /* æ‰¾åˆ°å­¸ç”Ÿåå­— */
            var students = STUDENTS[currentClassId] || [];
            for (var j = 0; j < students.length; j++) {
              if (students[j].id === keys[i]) {
                absentStudents.push({
                  name: students[j].name,
                  reason: st.reason,
                  note: st.note,
                });
                break;
              }
            }
          }
        }

        /* æ¨™è¨˜å®Œæˆ */
        state.done = true;

        /* è¨ˆç®—çµ±è¨ˆ */
        var total = keys.length;
        var absentCount = absentStudents.length;
        var presentCount = total - absentCount;

        /* æ‰¾åˆ°ç­ç´šåç¨± */
        var className = "";
        for (var i = 0; i < CLASSES.length; i++) {
          if (CLASSES[i].id === currentClassId) {
            className = CLASSES[i].name;
            break;
          }
        }

        /* å¡«å…¥å®Œæˆç•«é¢ */
        document.getElementById("complete-class-name").textContent = className;
        document.getElementById("sum-total").textContent = total;
        document.getElementById("sum-present").textContent = presentCount;
        document.getElementById("sum-absent").textContent = absentCount;

        /* ç¼ºå¸­åå–® */
        var absentHtml = "";
        if (absentStudents.length > 0) {
          absentHtml += '<div class="absent-list-title">ç¼ºå¸­/è«‹å‡åå–®</div>';
          for (var i = 0; i < absentStudents.length; i++) {
            var a = absentStudents[i];
            absentHtml += '<div class="absent-student">';
            absentHtml += "âŒ ";
            absentHtml += '<span class="name">' + a.name + "</span>";
            absentHtml += '<span class="reason">' + a.reason;
            if (a.note) absentHtml += "ï¼ˆ" + a.note + "ï¼‰";
            absentHtml += "</span>";
            absentHtml += "</div>";
          }
        }
        document.getElementById("absent-detail").innerHTML = absentHtml;

        showView("complete");
      }

      /* === è¿”å›ä»»å‹™åˆ—è¡¨ === */
      function backToTasks() {
        showView("tasks");
        init();
      }

      function backToTasksFromComplete() {
        showView("tasks");
        init();
      }

      /* é é¢è¼‰å…¥ */
      document.addEventListener("DOMContentLoaded", init);
    </script>
  </body>
</html>
